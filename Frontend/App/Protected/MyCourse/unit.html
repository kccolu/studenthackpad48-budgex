<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Fundamentals - Budgex</title>
    <link rel="stylesheet" href="unit.css">
</head>
<body>
    <script src="../Dashboard/api-client.js"></script>
    <script>
        // Check authentication on page load
        if (!api.isAuthenticated()) {
        window.location.href = '../../Public/Auth/signin.html';
    }

    // Load user profile after DOM content is ready
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const data = await api.getDashboardData();

            // Populate sidebar profile
            const usernameElem = document.getElementById('user-name');
            const emailElem = document.getElementById('user-email');
            const avatarElem = document.getElementById('user-avatar');

            if (usernameElem) usernameElem.textContent = data.user.username;
            if (emailElem) emailElem.textContent = data.user.email;
            if (avatarElem) avatarElem.textContent = data.user.avatar || data.user.username.substring(0,2).toUpperCase();

        } catch (error) {
            console.error('Failed to load user profile:', error);
            if (error.message.includes('token') || error.message.includes('401') || error.message.includes('403')) {
                alert('Your session has expired. Please log in again.');
                window.location.href = '../../Public/Auth/signin.html';
            }
        }
    });

    // Logout button functionality
    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    api.logout();
                }
            });
        }
    });
    </script>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">Budgex</div>

        <nav class="sidebar-nav">
            <a href="../../Protected/Dashboard/dashboard-interactive.html" class="nav-item">
                <span class="nav-icon icon-home"></span>
                <span>Dashboard</span>
            </a>
            <a href="mycourses.html" class="nav-item active">
                <span class="nav-icon icon-courses"></span>
                <span>My Courses</span>
            </a>
            <a href="../Tools/tools.html" class="nav-item">
                <span class="nav-icon icon-tools"></span>
                <span>Tools</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">JD</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-email" id="user-email">john@example.com</div>
                </div>
            </div>
            <a href="../../Public/Home/index.html" class="nav-item" id="logout-btn">
                <span class="nav-icon icon-logout"></span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="unit-header">
            <div class="breadcrumb">
                <a href="mycourses.html">My Courses</a>
                <span class="separator">/</span>
                <span class="current">Tax Fundamentals</span>
            </div>
            <h1 class="page-title">Tax Fundamentals</h1>
            <p class="course-subtitle">Master the basics of personal taxation, deductions, and filing requirements</p>
        </header>

        <!-- Course Progress Overview -->
        <section class="progress-overview">
            <div class="overview-card">
                <div class="overview-stat">
                    <div class="stat-icon">
                        <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="24" r="16" fill="#2ed573" stroke="#000" stroke-width="3"/>
                            <path d="M16 24 L21 29 L32 18" stroke="#000" stroke-width="4" stroke-linecap="square"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="completed-lessons">0</div>
                        <div class="stat-label">Lessons Completed</div>
                    </div>
                </div>
                <div class="overview-stat">
                    <div class="stat-icon">
                        <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="10" y="8" width="28" height="32" fill="#fbbf24" stroke="#000" stroke-width="3"/>
                            <rect x="14" y="8" width="20" height="4" fill="#f59e0b" stroke="#000" stroke-width="2"/>
                            <rect x="16" y="18" width="16" height="2" fill="#000"/>
                            <rect x="16" y="24" width="16" height="2" fill="#000"/>
                            <rect x="16" y="30" width="12" height="2" fill="#000"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-lessons">12</div>
                        <div class="stat-label">Total Lessons</div>
                    </div>
                </div>
                <div class="overview-stat">
                    <div class="stat-icon">
                        <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="28" r="14" fill="#fbbf24" stroke="#000" stroke-width="3"/>
                            <circle cx="24" cy="28" r="8" fill="#f59e0b" stroke="#000" stroke-width="2"/>
                            <circle cx="24" cy="28" r="3" fill="#000"/>
                            <rect x="23" y="8" width="2" height="10" fill="#fbbf24" stroke="#000" stroke-width="2"/>
                            <path d="M23 8 L20 14 L28 14 L25 8 Z" fill="#fbbf24" stroke="#000" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="avg-score">0%</div>
                        <div class="stat-label">Avg. Score</div>
                    </div>
                </div>
                <div class="overview-stat">
                    <div class="stat-icon">
                        <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="24" r="16" fill="#fbbf24" stroke="#000" stroke-width="3"/>
                            <rect x="23" y="12" width="2" height="12" fill="#000"/>
                            <rect x="23" y="24" width="8" height="2" fill="#000"/>
                            <circle cx="24" cy="24" r="2" fill="#000"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="time-spent">0h</div>
                        <div class="stat-label">Time Spent</div>
                    </div>
                </div>
            </div>

            <div class="overall-progress">
                <div class="progress-header">
                    <span class="progress-label">Overall Progress</span>
                    <span class="progress-percentage" id="overall-progress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- Course Units -->
        <section class="units-section">
            <h2 class="section-title">Course Content</h2>

            <!-- Unit 1: Getting Started -->
            <div class="unit-container">
                <div class="unit-header-card">
                    <div class="unit-number">Unit 1</div>
                    <div class="unit-info">
                        <h3 class="unit-title">Getting Started with Taxes</h3>
                        <p class="unit-description">Learn the fundamental concepts of taxation and why understanding taxes is essential for financial success.</p>
                        <div class="unit-meta">
                            <span class="meta-item">
                                <span class="meta-icon icon-book"></span>
                                <span>4 Lessons</span>
                            </span>
                            <span class="meta-item">
                                <span class="meta-icon icon-clock"></span>
                                <span>20 minutes</span>
                            </span>
                        </div>
                    </div>
                    <div class="unit-progress">
                        <div class="circular-progress">
                            <svg width="80" height="80" viewBox="0 0 80 80">
                                <circle cx="40" cy="40" r="32" fill="none" stroke="rgba(251, 191, 36, 0.2)" stroke-width="8"/>
                                <circle cx="40" cy="40" r="32" fill="none" stroke="#fbbf24" stroke-width="8"
                                        stroke-dasharray="201" stroke-dashoffset="201"
                                        transform="rotate(-90 40 40)" id="unit1-progress-circle"/>
                            </svg>
                            <div class="progress-text" id="unit1-progress-text">0%</div>
                        </div>
                    </div>
                </div>

                <div class="lessons-list">
                    <!-- Lesson 1 - Always unlocked -->
                    <div class="lesson-card unlocked" data-lesson="1" data-unit="1">
                        <div class="lesson-status">
                            <div class="status-icon icon-locked">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="8" fill="rgba(255, 255, 255, 0.1)" stroke="rgba(255, 255, 255, 0.4)" stroke-width="2"/>
                                </svg>
                            </div>
                        </div>
                        <div class="lesson-content">
                            <div class="lesson-header">
                                <h4 class="lesson-title">Lesson 1: Introduction to Taxation</h4>
                                <span class="lesson-badge unlocked-badge">Start</span>
                            </div>
                            <p class="lesson-description">Understand what taxes are, why we pay them, and how they impact your financial life.</p>
                            <div class="lesson-meta">
                                <span class="meta-item">
                                    <span class="meta-icon icon-clock"></span>
                                    <span>5 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon icon-book"></span>
                                    <span>3 Topics</span>
                                </span>
                            </div>
                        </div>
                        <button class="lesson-action-btn start-btn" onclick="window.location.href='./Unit1/IntroToTax.html?course=tax-fundamentals&unit=1&lesson=1'">
                            <span>Start Lesson</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 6 L18 12 L8 18 Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>

    
            <!-- Lesson 2 -->
<div class="lesson-card" data-lesson="2" data-unit="1" style="display: none;">
    <div class="lesson-status">
        <div class="status-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="8" fill="rgba(255, 255, 255, 0.1)" stroke="rgba(255, 255, 255, 0.4)" stroke-width="2"/>
            </svg>
        </div>
    </div>
    <div class="lesson-content">
        <div class="lesson-header">
            <h4 class="lesson-title">Lesson 2: Understanding Tax Brackets</h4>
            <span class="lesson-badge unlocked-badge">Start</span>
        </div>
        <p class="lesson-description">Learn how progressive tax systems work and how tax brackets affect your income.</p>
        <div class="lesson-meta">
            <span class="meta-item">
                <span class="meta-icon icon-clock"></span>
                <span>50 min</span>
            </span>
            <span class="meta-item">
                <span class="meta-icon icon-book"></span>
                <span>6 Topics</span>
            </span>
        </div>
    </div>
    <button class="lesson-action-btn start-btn">
        <span>Start Lesson</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 6 L18 12 L8 18 Z" fill="currentColor"/>
        </svg>
    </button>
</div>

                    <!-- Lesson 3 - Locked -->
                    <div class="lesson-card locked" data-lesson="3" data-unit="1">
                        <div class="lesson-status">
                            <div class="status-icon icon-locked">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="7" y="11" width="10" height="9" fill="#fbbf24" stroke="#000" stroke-width="2" rx="2"/>
                                    <path d="M9 11 L9 8 C9 6.5 10 5 12 5 C14 5 15 6.5 15 8 L15 11" stroke="#000" stroke-width="2" fill="none"/>
                                    <circle cx="12" cy="15" r="1.5" fill="#000"/>
                                </svg>
                            </div>
                        </div>
                        <div class="lesson-content">
                            <div class="lesson-header">
                                <h4 class="lesson-title">Lesson 3: Common Tax Deductions</h4>
                                <span class="lesson-badge locked-badge">Locked</span>
                            </div>
                            <p class="lesson-description">Discover common tax deductions that can help reduce your taxable income.</p>
                            <div class="lesson-meta">
                                <span class="meta-item">
                                    <span class="meta-icon icon-clock"></span>
                                    <span>40 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon icon-book"></span>
                                    <span>4 Topics</span>
                                </span>
                            </div>
                            <div class="lesson-requirement">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="8" r="7" stroke="#fbbf24" stroke-width="2" fill="none"/>
                                    <path d="M8 4 L8 9 L11 9" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>Complete Lesson 2 to unlock</span>
                            </div>
                        </div>
                        <button class="lesson-action-btn locked-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="7" y="11" width="10" height="9" fill="currentColor" stroke="#000" stroke-width="2" rx="2"/>
                                <path d="M9 11 L9 8 C9 6.5 10 5 12 5 C14 5 15 6.5 15 8 L15 11" stroke="#000" stroke-width="2" fill="none"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Lesson 4 - Locked -->
                    <div class="lesson-card locked" data-lesson="4" data-unit="1">
                        <div class="lesson-status">
                            <div class="status-icon icon-locked">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="7" y="11" width="10" height="9" fill="#fbbf24" stroke="#000" stroke-width="2" rx="2"/>
                                    <path d="M9 11 L9 8 C9 6.5 10 5 12 5 C14 5 15 6.5 15 8 L15 11" stroke="#000" stroke-width="2" fill="none"/>
                                    <circle cx="12" cy="15" r="1.5" fill="#000"/>
                                </svg>
                            </div>
                        </div>
                        <div class="lesson-content">
                            <div class="lesson-header">
                                <h4 class="lesson-title">Lesson 4: Filing Status Options</h4>
                                <span class="lesson-badge locked-badge">Locked</span>
                            </div>
                            <p class="lesson-description">Learn about different filing statuses and how to choose the right one for you.</p>
                            <div class="lesson-meta">
                                <span class="meta-item">
                                    <span class="meta-icon icon-clock"></span>
                                    <span>35 min</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon icon-book"></span>
                                    <span>5 Topics</span>
                                </span>
                            </div>
                            <div class="lesson-requirement">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="8" r="7" stroke="#fbbf24" stroke-width="2" fill="none"/>
                                    <path d="M8 4 L8 9 L11 9" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>Complete Lesson 3 to unlock</span>
                            </div>
                        </div>
                        <button class="lesson-action-btn locked-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="7" y="11" width="10" height="9" fill="currentColor" stroke="#000" stroke-width="2" rx="2"/>
                                <path d="M9 11 L9 8 C9 6.5 10 5 12 5 C14 5 15 6.5 15 8 L15 11" stroke="#000" stroke-width="2" fill="none"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                api.logout();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
    console.log('Page loaded - loading course data...');

    const lessonPageMap = {
        1: 'IntroToTax.html',
        2: 'TaxBrackets.html',
        3: 'Deductions.html',
        4: 'FilingOptions.html'
    };

    // Function to load fresh course data from backend
    async function loadCourseData() {
        try {
            const courses = await api.getCourses();
            let courseData = courses.find(c => c.courseId === 'tax-fundamentals');

            if (!courseData) {
                console.log('Not enrolled yet, enrolling in course...');
                courseData = await api.enrollCourse('tax-fundamentals', 'Tax Fundamentals', 4);
            }

            console.log('Course data loaded:', courseData);
            return courseData;
        } catch (e) {
            console.error('Failed to fetch course data:', e);
            // Return default structure if backend fails
            return {
                lessonsTotal: 4,
                lessonsCompleted: 0,
                currentLesson: 1,
                lessons: []
            };
        }
    }

    // Load course data
    let courseData = await loadCourseData();

    // Extract completed lessons from backend data
    let completedLessons = courseData.lessons
        ? courseData.lessons.filter(l => l.completed).map(l => Number(l.lessonId))
        : [];

    console.log('Completed lessons:', completedLessons);
    console.log('Current lesson (max unlocked):', courseData.currentLesson);

    // Function to update lesson UI based on backend data
    function updateLessonUI() {
        const lessonCards = document.querySelectorAll('.lesson-card');

        lessonCards.forEach(card => {
            const lessonNum = Number(card.dataset.lesson);
            const actionBtn = card.querySelector('.lesson-action-btn');
            const badge = card.querySelector('.lesson-badge');

            // A lesson is unlocked if:
            // - It's lesson 1, OR
            // - Its lesson number is <= currentLesson from backend
            const isUnlocked = lessonNum <= courseData.currentLesson;
            const isCompleted = completedLessons.includes(lessonNum);

            // Show lesson if it's unlocked
            card.style.display = isUnlocked ? 'flex' : 'none';

            if (isCompleted) {
                // Lesson is completed
                card.classList.add('completed');
                card.classList.remove('unlocked', 'locked');
                if (badge) {
                    badge.textContent = 'Completed';
                    badge.className = 'lesson-badge completed-badge';
                }
                if (actionBtn) {
                    actionBtn.disabled = false;
                    actionBtn.innerHTML = '<span>Review</span>';
                    actionBtn.className = 'lesson-action-btn review-btn';
                }
            } else if (isUnlocked) {
                // Lesson is unlocked but not completed
                card.classList.add('unlocked');
                card.classList.remove('locked', 'completed');
                if (badge) {
                    badge.textContent = 'Start';
                    badge.className = 'lesson-badge unlocked-badge';
                }
                if (actionBtn) {
                    actionBtn.disabled = false;
                    actionBtn.innerHTML = '<span>Start Lesson</span>';
                    actionBtn.className = 'lesson-action-btn start-btn';
                }
            } else {
                // Lesson is locked
                card.classList.add('locked');
                card.classList.remove('unlocked', 'completed');
                if (badge) {
                    badge.textContent = 'Locked';
                    badge.className = 'lesson-badge locked-badge';
                }
                if (actionBtn) {
                    actionBtn.disabled = true;
                    actionBtn.className = 'lesson-action-btn locked-btn';
                }
            }

            // Attach click handler - only navigate to lesson, don't mark complete
            if (actionBtn && !actionBtn.disabled) {
                actionBtn.onclick = () => {
                    const page = lessonPageMap[lessonNum];
                    // Just navigate to the lesson - completion happens inside the lesson
                    window.location.href = `./Unit1/${page}?course=tax-fundamentals&unit=1&lesson=${lessonNum}`;
                };
            }
        });
    }

    // Function to update stats display
    function updateStats() {
        const completedCount = completedLessons.length;
        const totalLessons = 4;
        const overallProgress = Math.round((completedCount / totalLessons) * 100);

        document.getElementById('completed-lessons').textContent = completedCount;
        document.getElementById('total-lessons').textContent = totalLessons;
        document.getElementById('overall-progress').textContent = overallProgress + '%';
        document.getElementById('progress-fill').style.width = overallProgress + '%';
        document.getElementById('unit1-progress-text').textContent = overallProgress + '%';

        // Update circular progress
        const circumference = 2 * Math.PI * 32;
        const offset = circumference - (overallProgress / 100) * circumference;
        document.getElementById('unit1-progress-circle').style.strokeDashoffset = offset;

        // Update average score if available
        if (courseData.lessons && courseData.lessons.length > 0) {
            const scoredLessons = courseData.lessons.filter(l => l.completed && l.score);
            if (scoredLessons.length > 0) {
                const avgScore = Math.round(
                    scoredLessons.reduce((sum, l) => sum + l.score, 0) / scoredLessons.length
                );
                document.getElementById('avg-score').textContent = avgScore + '%';
            }
        }
    }

    // Initial render
    updateLessonUI();
    updateStats();

    console.log('UI initialized successfully');
});
</script>
