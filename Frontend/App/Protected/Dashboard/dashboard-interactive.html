<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Budgex</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="data.js"></script>
    <style>
        .export-btn {
            width: 48px;
            height: 48px;
            background: rgba(20, 30, 48, 0.8);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 2px 2px 0 rgba(251, 191, 36, 0.2);
        }

        .export-btn:hover {
            background: rgba(20, 30, 48, 0.95);
            border-color: rgba(251, 191, 36, 0.6);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 rgba(251, 191, 36, 0.3), 0 0 10px rgba(251, 191, 36, 0.2);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">Budgex</div>

        <nav class="sidebar-nav">
            <a href="dashboard-interactive.html" class="nav-item active">
                <span class="nav-icon icon-home"></span>
                <span>Dashboard</span>
            </a>
            <a href="../MyCourse/mycourses.html" class="nav-item">
                <span class="nav-icon icon-courses"></span>
                <span>My Courses</span>
            </a>
            <a href="../Tools/tools.html" class="nav-item">
                <span class="nav-icon icon-tools"></span>
                <span>Tools</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">JD</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-email" id="user-email">john@example.com</div>
                </div>
            </div>
            <a href="../../Public/Home/index.html" class="nav-item" id="logout-btn">
                <span class="nav-icon icon-logout"></span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1 class="welcome-title" id="welcome-title">Welcome back, John!</h1>
                    <p class="welcome-subtitle">Ready to continue your financial education journey?</p>
                </div>
                <div class="header-actions">
                    <button class="notification-btn" id="notification-btn">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge" id="activity-count">0</span>
                    </button>
                    <button class="export-btn" id="export-data" title="Export Progress Data">
                        <span>üìä</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Experience Level Section -->
        <section class="level-section">
            <div class="level-card">
                <div class="level-icon">‚≠ê</div>
                <div class="level-details">
                    <div class="level-header">
                        <h3 class="level-title">Level <span id="current-level">1</span></h3>
                        <span class="level-badge" id="rank-badge">Beginner</span>
                    </div>
                    <div class="xp-info">
                        <span id="current-xp">0</span> / <span id="next-level-xp">10</span> XP
                    </div>
                    <div class="level-progress-bar">
                        <div class="level-progress-fill" id="level-progress-fill" style="width: 0%"></div>
                    </div>
                    <p class="level-description">Complete lessons to gain experience and level up!</p>
                </div>
            </div>
        </section>

        <!-- Stats Overview -->
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg class="book-icon-svg" width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" aria-labelledby="bookTitle" role="img">
                        <title id="bookTitle">Empty open book icon with yellow outline</title>
                      
                        <!-- left cover/page -->
                        <path d="M10 18
                                 C18 14, 36 14, 40 22
                                 L40 58
                                 C32 54, 18 54, 10 58
                                 Z"
                              fill="none"
                              stroke="#fbbf24"
                              stroke-width="3"
                              stroke-linejoin="round"
                              stroke-linecap="round"/>
                      
                        <!-- right cover/page -->
                        <path d="M70 18
                                 C62 14, 44 14, 40 22
                                 L40 58
                                 C48 54, 62 54, 70 58
                                 Z"
                              fill="none"
                              stroke="#fbbf24"
                              stroke-width="3"
                              stroke-linejoin="round"
                              stroke-linecap="round"/>
                      
                        <!-- center spine / gutter -->
                        <path d="M40 22
                                 L40 58"
                              fill="none"
                              stroke="#fbbf24"
                              stroke-width="2"
                              stroke-linecap="round"/>
                      
                        <!-- subtle bottom crease to suggest pages -->
                        <path d="M14 56
                                 C24 52, 36 52, 40 56
                                 C44 52, 56 52, 66 56"
                              fill="none"
                              stroke="#fbbf24"
                              stroke-width="2"
                              stroke-linecap="round"/>
                      </svg>
                <div class="stat-details">
                    <div class="stat-value" id="stat-enrolled">0</div>
                    <div class="stat-label">Courses Enrolled</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-details">
                    <div class="stat-value" id="stat-completed">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-details">
                    <div class="stat-value" id="stat-time">0h</div>
                    <div class="stat-label">Learning Time</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-details">
                    <div class="stat-value" id="stat-score">0%</div>
                    <div class="stat-label">Avg. Score</div>
                </div>
            </div>
        </section>

        <!-- Course Categories -->
        <section class="courses-section">
            <div class="section-header">
                <h2 class="section-title">Explore Courses</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="beginner">Beginner</button>
                    <button class="filter-btn" data-filter="intermediate">Intermediate</button>
                    <button class="filter-btn" data-filter="advanced">Advanced</button>
                </div>
            </div>

            <div class="courses-grid" id="courses-grid">
                <!-- Courses will be loaded dynamically -->
            </div>
        </section>
    </main>

    <script src="api-client.js"></script>
    <script>
        // Check authentication on page load
        if (!api.isAuthenticated()) {
            window.location.href = '../../Public/Auth/signin.html';
        }

        // Global variable to store dashboard data
        let currentDashboardData = null;

        // Load and display dashboard data
        async function loadDashboardData() {
            try {
                // Fetch from backend API
                const data = await api.getDashboardData();
                currentDashboardData = data;

                // Update user info
                const firstName = data.user.username || 'User';
                document.getElementById('user-name').textContent = data.user.username;
                document.getElementById('user-email').textContent = data.user.email;
                document.getElementById('user-avatar').textContent = data.user.avatar || data.user.username.substring(0, 2).toUpperCase();
                document.getElementById('welcome-title').textContent = `Welcome back, ${firstName}!`;

                // Update stats
                const stats = data.stats || { coursesEnrolled: 0, coursesCompleted: 0, learningTimeHours: 0, averageScore: 0 };
                document.getElementById('stat-enrolled').textContent = stats.coursesEnrolled || 0;
                document.getElementById('stat-completed').textContent = stats.coursesCompleted || 0;
                document.getElementById('stat-time').textContent = (stats.learningTimeHours || 0) + 'h';
                document.getElementById('stat-score').textContent = (stats.averageScore || 0) + '%';
                document.getElementById('activity-count').textContent = (data.activities || []).length;

                // Calculate and update experience level (1 XP per completed lesson)
                const completedLessons = stats.completedLessons || 0;
                updateExperienceLevel(completedLessons);

                // Load courses dynamically
                await loadCoursesFromAPI(data.courses || []);
            } catch (error) {
                console.error('Failed to load from API:', error);

                // If authentication failed, redirect to login
                if (error.message.includes('token') || error.message.includes('401') || error.message.includes('403')) {
                    alert('Your session has expired. Please log in again.');
                    window.location.href = '../../Public/Auth/signin.html';
                    return;
                }

                // Otherwise show error message
                alert('Failed to load dashboard data: ' + error.message);

                // Show empty state
                document.getElementById('stat-enrolled').textContent = '0';
                document.getElementById('stat-completed').textContent = '0';
                document.getElementById('stat-time').textContent = '0h';
                document.getElementById('stat-score').textContent = '0%';
                document.getElementById('activity-count').textContent = '0';
            }
        }

        // Available courses catalog (these are all available courses)
        const availableCoursesForDisplay = [
    {
        id: "tax-fundamentals",
        title: "Tax Fundamentals",
        iconClass: "icon-tax",
        level: "beginner",
        lessonsTotal: 4,
        timeEstimate: "20 minutes"
    },
    {
        id: "investment-strategies",
        title: "Investment Strategies",
        iconClass: "icon-investment",
        level: "intermediate",
        lessonsTotal: "N/A",
        timeEstimate: "N/A"
    },
    {
        id: "business-finance",
        title: "Business Finance",
        iconClass: "icon-business",
        level: "advanced",
        lessonsTotal: "N/A",
        timeEstimate: "N/A"
    },
    {
        id: "retirement-planning",
        title: "Retirement Planning",
        iconClass: "icon-retirement",
        level: "intermediate",
        lessonsTotal: "N/A",
        timeEstimate: "N/A"
    },
    {
        id: "real-estate",
        title: "Real Estate Investing",
        iconClass: "icon-house",
        level: "advanced",
        lessonsTotal: "N/A",
        timeEstimate: "N/A"
    },
    {
        id: "crypto-taxes",
        title: "Cryptocurrency & Taxes",
        iconClass: "icon-crypto",
        level: "intermediate",
        lessonsTotal: "N/A",
        timeEstimate: "7 hours"
    }
];

        async function loadCoursesFromAPI(enrolledCourses) {
            const coursesGrid = document.getElementById('courses-grid');
            coursesGrid.innerHTML = '';

            // Map enrolled courses by courseId for quick lookup
            const enrolledMap = {};
            (enrolledCourses || []).forEach(course => {
                enrolledMap[course.courseId] = course;
            });

            // Display all available courses with enrollment status
            availableCoursesForDisplay.forEach(catalogCourse => {
                const enrolledCourse = enrolledMap[catalogCourse.id];
                const progress = enrolledCourse ? enrolledCourse.progress : 0;
                const isEnrolled = !!enrolledCourse;

                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                courseCard.dataset.course = catalogCourse.id;
                courseCard.dataset.level = catalogCourse.level;

                const badgeClass = catalogCourse.level === 'beginner' ? 'beginner' :
                                  catalogCourse.level === 'intermediate' ? 'intermediate' : 'advanced';

                const isAvailable = catalogCourse.id === "tax-fundamentals"; // only this course is available
                const buttonText = isAvailable
                    ? (isEnrolled ? (progress > 0 ? "Continue Learning" : "Start Course") : "Start Course")
                    : "Coming Soon";

                courseCard.innerHTML = `
                    <div class="course-header">
                        <div class="course-icon">${catalogCourse.icon}</div>
                        <span class="course-badge ${badgeClass}">${catalogCourse.level}</span>
                    </div>
                    <h3 class="course-title">${catalogCourse.title}</h3>
                    <p class="course-description">Master ${catalogCourse.title.toLowerCase()} with comprehensive lessons.</p>
                    <div class="course-meta">
                        <span class="meta-item">
                            <span class="meta-icon">üìö</span>
                            <span>${catalogCourse.lessonsTotal} Lessons</span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">‚è±Ô∏è</span>
                            <span>${catalogCourse.timeEstimate}</span>
                        </span>
                    </div>
                    <div class="course-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <span class="progress-text">${progress}% Complete</span>
                    </div>
                    <button class="course-btn ${!isAvailable ? 'coming-soon' : ''}" ${!isAvailable ? 'disabled' : ''}>${buttonText}</button>
                `;

                const courseBtn = courseCard.querySelector('.course-btn');


            if (!courseBtn.hasAttribute('disabled')) {
                courseBtn.addEventListener('click', () => {
                    handleCourseClick(catalogCourse, isEnrolled);
                });
            } else {
    
                courseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                });
            }
                coursesGrid.appendChild(courseCard);
            });
        }

        async function handleCourseClick(course, isEnrolled) {
            if (!isEnrolled) {
                // Enroll in the course via API
                try {
                    const response = await api.enrollCourse(course.id, course.title, course.lessonsTotal);
                    showNotification(`Enrolled in ${course.title}!`);

                    // Refresh dashboard data
                    await loadDashboardData();
                } catch (error) {
                    console.error('Enrollment failed:', error);
                    alert('Failed to enroll: ' + error.message);
                    return;
                }
            } else {
                showNotification(`Continuing ${course.title}...`);
            }

            // Navigate to courses page
            setTimeout(() => {
                window.location.href = '../MyCourse/mycourses.html';
            }, 500);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(135deg, #2d5016, #4a8c2a);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(74, 140, 42, 0.4);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Export data functionality
        document.getElementById('export-data').addEventListener('click', () => {
            if (!currentDashboardData) {
                showNotification('No data to export');
                return;
            }

            // Create CSV from current dashboard data
            let csv = "TaxMaster Progress Report\n\n";
            csv += `User: ${currentDashboardData.user.username}\n`;
            csv += `Email: ${currentDashboardData.user.email}\n`;
            csv += `Export Date: ${new Date().toLocaleDateString()}\n\n`;

            csv += "=== STATISTICS ===\n";
            const stats = currentDashboardData.stats || {};
            csv += `Courses Enrolled: ${stats.coursesEnrolled || 0}\n`;
            csv += `Courses Completed: ${stats.coursesCompleted || 0}\n`;
            csv += `Learning Time: ${stats.learningTimeHours || 0} hours\n`;
            csv += `Average Score: ${stats.averageScore || 0}%\n`;
            csv += `Completed Lessons: ${stats.completedLessons || 0}\n\n`;

            csv += "=== ENROLLED COURSES ===\n";
            csv += "Course ID,Title,Progress,Lessons Completed,Total Lessons,Last Accessed\n";

            const courses = currentDashboardData.courses || [];
            courses.forEach(course => {
                const lastAccessed = course.lastAccessed ? new Date(course.lastAccessed).toLocaleDateString() : 'Never';
                csv += `"${course.courseId}","${course.courseTitle}","${course.progress}%","${course.lessonsCompleted}","${course.lessonsTotal}","${lastAccessed}"\n`;
            });

            csv += "\n=== RECENT ACTIVITIES ===\n";
            csv += "Date,Type,Title,Score\n";

            const activities = currentDashboardData.activities || [];
            activities.forEach(activity => {
                const date = new Date(activity.date).toLocaleDateString();
                const score = activity.score || 'N/A';
                csv += `"${date}","${activity.type}","${activity.title || ''}","${score}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TaxMaster_Progress_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification('Progress data exported!');
        });

        // Notification button
        document.getElementById('notification-btn').addEventListener('click', () => {
            const activities = currentDashboardData?.activities || [];
            let activityHTML = '<div style="position: fixed; top: 80px; right: 20px; width: 350px; max-height: 500px; overflow-y: auto; background: rgba(20, 20, 20, 0.98); border: 1px solid rgba(74, 140, 42, 0.3); border-radius: 15px; padding: 1.5rem; z-index: 10000; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">';
            activityHTML += '<h3 style="color: #fff; margin-bottom: 1rem; font-size: 1.25rem;">Recent Activity</h3>';

            if (activities.length === 0) {
                activityHTML += '<p style="color: #c0c0c0;">No recent activity. Start learning to see your progress!</p>';
            } else {
                activities.forEach(activity => {
                    const date = new Date(activity.date).toLocaleDateString();
                    const activityTitle = activity.title || `${activity.type.replace(/_/g, ' ')}`;
                    activityHTML += `
                        <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 0.75rem;">
                            <p style="color: #fff; font-weight: 600; margin-bottom: 0.25rem;">${activityTitle}</p>
                            <p style="color: #c0c0c0; font-size: 0.85rem;">${date}${activity.score ? ` ‚Ä¢ Score: ${activity.score}%` : ''}</p>
                        </div>
                    `;
                });
            }
            activityHTML += '<button onclick="this.parentElement.remove()" style="width: 100%; padding: 0.75rem; margin-top: 1rem; background: linear-gradient(135deg, #2d5016, #4a8c2a); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Close</button>';
            activityHTML += '</div>';

            const existingPanel = document.querySelector('[style*="top: 80px"]');
            if (existingPanel) existingPanel.remove();
            else {
                const panel = document.createElement('div');
                panel.innerHTML = activityHTML;
                document.body.appendChild(panel);
            }
        });

        // Filter courses
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.dataset.filter;
                const cards = document.querySelectorAll('.course-card');

                cards.forEach(card => {
                    if (filter === 'all' || card.dataset.level === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Experience Level System
        function updateExperienceLevel(completedLessons) {
            const xp = completedLessons; // 1 XP per lesson

            // Calculate level (10 lessons per level)
            const level = Math.floor(xp / 10) + 1;
            const currentLevelXP = xp % 10;
            const nextLevelXP = 10;
            const progressPercent = (currentLevelXP / nextLevelXP) * 100;

            // Determine rank based on level
            let rank = 'Beginner';
            if (level >= 20) rank = 'Master';
            else if (level >= 15) rank = 'Expert';
            else if (level >= 10) rank = 'Advanced';
            else if (level >= 5) rank = 'Intermediate';

            // Update UI
            document.getElementById('current-level').textContent = level;
            document.getElementById('current-xp').textContent = currentLevelXP;
            document.getElementById('next-level-xp').textContent = nextLevelXP;
            document.getElementById('level-progress-fill').style.width = progressPercent + '%';
            document.getElementById('rank-badge').textContent = rank;
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                api.logout();
            }
        });

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
        });
    </script>
</body>
</html>
