<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Courses - Budgex</title>
    <link rel="stylesheet" href="mycourses.css">
</head>
<body>
    <script src="../Dashboard/api-client.js"></script>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">Budgex</div>

        <nav class="sidebar-nav">
            <a href="../../Protected/Dashboard/dashboard-interactive.html" class="nav-item">
                <span class="nav-icon icon-home"></span>
                <span>Dashboard</span>
            </a>
            <a href="mycourses.html" class="nav-item active">
                <span class="nav-icon icon-courses"></span>
                <span>My Courses</span>
            </a>
            <a href="../Tools/tools.html" class="nav-item">
                <span class="nav-icon icon-tools"></span>
                <span>Tools</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">JD</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-email" id="user-email">john@example.com</div>
                </div>
            </div>
            <a href="#" class="nav-item" id="logout-btn">
                <span class="nav-icon icon-logout"></span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="course-header">
            <div>
                <h1 class="page-title">My Courses</h1>
            </div>
            <div class="header-actions">
                <select class="sort-select" id="sort-select">
                    <option value="recent">Recently Accessed</option>
                    <option value="progress">Progress</option>
                    <option value="name">Name</option>
                    <option value="difficulty">Difficulty</option>
                </select>
            </div>
        </header>

        <!-- Active Courses -->
        <section class="courses-section" id="active-courses-section">
            <h2 class="section-title">Continue Learning</h2>

            <div class="course-list" id="active-courses-list">
                <!-- Dynamically loaded active courses will appear here -->
            </div>
            <div class="empty-state" id="active-empty-state" style="display: none;">
                <p>You haven't started any courses yet. Check out the available courses below!</p>
            </div>
        </section>

        <!-- Not Started Courses -->
        <section class="courses-section" id="available-courses-section">
            <h2 class="section-title">Ready to Start</h2>

            <div class="course-grid" id="available-courses-grid">
                <!-- Dynamically loaded available courses will appear here -->
            </div>
            <div class="empty-state" id="available-empty-state" style="display: none;">
                <p>All available courses have been started!</p>
            </div>
        </section>
    </main>

    <script>
        // Available courses catalog
        const COURSE_CATALOG = {
            "tax-fundamentals": {
                id: "tax-fundamentals",
                title: "Tax Fundamentals",
                description: "Master the basics of personal taxation, deductions, and filing requirements.",
                level: "beginner",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-tax"
            },
            "investment-strategies": {
                id: "investment-strategies",
                title: "Investment Strategies",
                description: "Learn proven investment strategies and portfolio management techniques.",
                level: "intermediate",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-investment",
                comingSoon: true
            },
            "business-finance": {
                id: "business-finance",
                title: "Business Finance",
                description: "Understand business taxation, accounting principles, and financial planning.",
                level: "advanced",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-business",
                comingSoon: true
            },
            "retirement-planning": {
                id: "retirement-planning",
                title: "Retirement Planning",
                description: "Plan for your future with 401(k), IRA, and retirement savings strategies.",
                level: "intermediate",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-retirement",
                comingSoon: true
            },
            "real-estate": {
                id: "real-estate",
                title: "Real Estate Investing",
                description: "Explore real estate investment strategies and property tax implications.",
                level: "advanced",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-house",
                comingSoon: true
            },
            "crypto-taxes": {
                id: "crypto-taxes",
                title: "Cryptocurrency & Taxes",
                description: "Navigate crypto taxation, capital gains, and blockchain transactions.",
                level: "intermediate",
                lessonsTotal: "N/A",
                timeEstimate: "N/A",
                iconClass: "icon-crypto",
                comingSoon: true
            },
        };
        let enrolledCourses = [];
        let currentSort = 'recent';
        

        async function loadUserCourses() {
                try {
                    const data = await api.getDashboardData();

        // Load user profile
                    const user = data.user || {};
                    const firstName = user.username || 'User';
                    document.getElementById('user-name').textContent = firstName;
                    document.getElementById('user-email').textContent = user.email || '';
                    document.getElementById('user-avatar').textContent = user.avatar || firstName.substring(0, 2).toUpperCase();

        // Load enrolled courses
                    enrolledCourses = (data.courses || []).filter(c => c.enrolledDate); // only show enrolled courses

        // Render courses
                    renderCourses();
                } catch (error) {
                    console.error('Failed to load user courses:', error);
                    renderCourses();
                }
            }


        // Render active and available courses
        function renderCourses() {
            const activeCoursesList = document.getElementById('active-courses-list');
            const availableCoursesGrid = document.getElementById('available-courses-grid');
            const activeEmptyState = document.getElementById('active-empty-state');
            const availableEmptyState = document.getElementById('available-empty-state');

            activeCoursesList.innerHTML = '';
            availableCoursesGrid.innerHTML = '';

            // Get enrolled course IDs
            const enrolledIds = new Set(enrolledCourses.map(c => c.courseId));

            // Separate active (enrolled with progress) and available courses
            const activeCourses = enrolledCourses.filter(c => c.progress > 0 || c.completedLessons > 0);
            const availableCourses = Object.values(COURSE_CATALOG).filter(c => !enrolledIds.has(c.id));

            // Sort active courses
            sortCourses(activeCourses);

            // Render active courses
            if (activeCourses.length === 0) {
                activeEmptyState.style.display = 'block';
            } else {
                activeEmptyState.style.display = 'none';
                activeCourses.forEach(courseData => {
                    const course = COURSE_CATALOG[courseData.courseId];
                    if (course) {
                        activeCoursesList.appendChild(createActiveCourseCard(course, courseData));
                    }
                });
            }

            // Render available courses
            if (availableCourses.length === 0) {
                availableEmptyState.style.display = 'block';
            } else {
                availableEmptyState.style.display = 'none';
                availableCourses.forEach(course => {
                    availableCoursesGrid.appendChild(createAvailableCourseCard(course));
                });
            }

            // Attach event listeners
            attachEventListeners();
        }

        // Create active course card HTML
        function createActiveCourseCard(course, progressData) {
            const progress = progressData.progress || 0;
            const completedLessons = progressData.completedLessons || 0;
            const currentLesson = progressData.currentLesson || 1;
            const lastAccessed = progressData.lastAccessed || Date.now();

            const card = document.createElement('div');
            card.className = 'course-item';
            card.dataset.courseId = course.id;
            card.dataset.lastAccessed = lastAccessed;
            card.dataset.progress = progress;
            card.dataset.difficulty = course.level;

            card.innerHTML = `
                <div class="course-content">
                    <div class="course-header-section">
                        <div class="course-icon-large ${course.iconClass}"></div>
                        <div class="course-info">
                            <h3 class="course-title">${course.title}</h3>
                            <p class="course-description">${course.description}</p>
                            <div class="course-meta">
                                <span class="meta-badge ${course.level}">${capitalize(course.level)}</span>
                                <span class="meta-item">
                                    <span class="meta-icon icon-book"></span>
                                    <span>${course.lessonsTotal} Lessons</span>
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon icon-clock"></span>
                                    <span>${course.timeEstimate}</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Overall Progress</span>
                            <span class="progress-percentage">${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-stats">
                            <span>${completedLessons} of ${course.lessonsTotal} lessons completed</span>
                        </div>
                    </div>

                    <div class="course-actions">
                        <button class="btn-primary continue-btn">Continue Lesson ${currentLesson}</button>
                        <button class="btn-secondary view-all-btn">View All Lessons</button>
                    </div>
                </div>
            `;

            return card;
        }

        // Create available course card HTML
        function createAvailableCourseCard(course) {
    const card = document.createElement('div');
    card.className = 'course-card';
    card.dataset.courseId = course.id;

    const isComingSoon = course.comingSoon === true;

    card.innerHTML = `
        <div class="course-icon-medium ${course.iconClass}"></div>
        
        ${isComingSoon ? `<span class="coming-soon-badge">Coming Soon</span>` 
                       : `<span class="course-badge ${course.level}">${capitalize(course.level)}</span>`}
                       
        <h3 class="card-title">${course.title}</h3>
        <p class="card-description">${course.description}</p>
        <div class="card-meta">
            <span class="meta-item">
                <span class="meta-icon icon-book"></span>
                <span>${course.lessonsTotal} Lessons</span>
            </span>
            <span class="meta-item">
                <span class="meta-icon icon-clock"></span>
                <span>${course.timeEstimate}</span>
            </span>
        </div>

        ${isComingSoon 
            ? `<button class="btn-outline start-btn" disabled>Coming Soon</button>` 
            : `<button class="btn-outline start-btn">Start Course</button>`}
    `;

    return card;
}

        // Sort courses based on selected criteria
        function sortCourses(courses) {
            switch (currentSort) {
                case 'recent':
                    courses.sort((a, b) => (b.lastAccessed || 0) - (a.lastAccessed || 0));
                    break;
                case 'progress':
                    courses.sort((a, b) => (b.progress || 0) - (a.progress || 0));
                    break;
                case 'name':
                    courses.sort((a, b) => {
                        const nameA = COURSE_CATALOG[a.courseId]?.title || '';
                        const nameB = COURSE_CATALOG[b.courseId]?.title || '';
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'difficulty':
                    const difficultyOrder = { 'beginner': 1, 'intermediate': 2, 'advanced': 3 };
                    courses.sort((a, b) => {
                        const levelA = COURSE_CATALOG[a.courseId]?.level || 'beginner';
                        const levelB = COURSE_CATALOG[b.courseId]?.level || 'beginner';
                        return difficultyOrder[levelA] - difficultyOrder[levelB];
                    });
                    break;
            }
        }

        // Attach event listeners to buttons
        function attachEventListeners() {
            // Continue learning buttons
            document.querySelectorAll('.continue-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseItem = e.target.closest('.course-item');
                    const courseId = courseItem.dataset.courseId;
                    // Navigate to unit page
                    window.location.href = `unit.html?course=${courseId}`;
                });
            });

            // View all lessons buttons
            document.querySelectorAll('.view-all-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseItem = e.target.closest('.course-item');
                    const courseId = courseItem.dataset.courseId;
                    // Navigate to unit page
                    window.location.href = `unit.html?course=${courseId}`;
                });
            });

            // Start course buttons
            document.querySelectorAll('.start-btn').forEach(async (btn) => {
                btn.addEventListener('click', async (e) => {
                    const courseCard = e.target.closest('.course-card');
                    const courseId = courseCard.dataset.courseId;

                    // Enroll user in course
                    try {
                        await api.enrollInCourse(courseId);
                        // Navigate to unit page
                        window.location.href = `unit.html?course=${courseId}`;
                    } catch (error) {
                        console.error('Failed to enroll in course:', error);
                        // Still navigate even if enrollment fails
                        window.location.href = `unit.html?course=${courseId}`;
                    }
                });
            });
        }

        // Sort functionality
        document.getElementById('sort-select').addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderCourses();
        });

        // Utility function to capitalize first letter
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        if (!api.isAuthenticated()) {
            window.location.href = '../../Public/Auth/signin.html';
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const data = await api.getDashboardData();
                document.getElementById('user-name').textContent = data.user.username;
                document.getElementById('user-email').textContent = data.user.email;
                document.getElementById('user-avatar').textContent = data.user.avatar || data.user.username.substring(0, 2).toUpperCase();
            } catch (error) {
                console.error('Failed to load user profile:', error);
                if (error.message.includes('token') || error.message.includes('401') || error.message.includes('403')) {
                    alert('Your session has expired. Please log in again.');
                    window.location.href = '../../Public/Auth/signin.html';
                }
            }
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                api.logout();
            }
        });


        // Load courses on page load
        loadUserCourses();
    </script>
</body>
</html>
